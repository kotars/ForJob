# Отче наш, иже еси на АйБиЭм ПиСи, код наш насущный дай нам!
# Помилуй нас от пэйпер джэма и фатал эрора! 
# Дай нам MD-ков неубываемых и паролей на них.
# Искупи нам десницей Своей комплектующих для Апгрейда ненасытного, ибо душит нас Жаба великая
# и страдаем мы от недостатка ресурсов системных. 
# Не допусти выполнения недопустимой операции и скрой сведения от очей наших.
# Не дай нам впасть во искушение новыми релизами, ибо лукав Нуралиев-искуситель сотоварищи. 
# Удержи нас грешных от эф-диска и формата. Да минуют нас бэд-блоки и вирусы. 
# Умерь гордыню нашу, ибо не зашарим и крохи малой ближнему своему.
# Избавь нас от Юзера глупого, ибо продвинут он стал и имя ему БУХ. 
# Выправи программы наши кривые, ибо клинит башни нам от конфигураторов и отладчиков Открой нам знание, ибо истинно говоришь Ты нам, где тру и фолс. 
# Откомментируй код наш многомегабайтный, ибо погрязли мы в MD-шниках своих

# Укроти ламеров, имя Твое всуе поминающих, ибо не ведают, что творят. Упаси нас от Галактик и Бэстов. Да приидет царствие одинэса. 
# Не заставь нас нырять в мануалы бездонные и хэлпы путанные, ибо ересь в них, а дай нам уразуметь ридмя крошечные,
# ибо в них слово Господне.

# Инкапсулируй объекты наши, ибо полиморфны они и наследуют Царствие Твое. Выведи нас из цикла бесконечного, 
# ибо на переход Твой безусловный уповаем. Укажи нам путь верный, ибо блуждаем мы средь интерфейсов и парадигм и несть им числа.
# Не пронеси мимо чашу сию неупиваемую, ибо пива
# жаждем мы и коннекта алкаем.

# Молим Тебя и ниц перед Тобой падаем со серверами нашими. Отныне и присно, энд лайфтайм, бэкап!


# ██████╗  ██████╗ ███████╗███████╗██╗   ██╗██████╗ ███████╗██████╗ 
# ██╔══██╗██╔═══██╗██╔════╝██╔════╝╚██╗ ██╔╝██╔══██╗██╔════╝██╔══██╗
# ██████╔╝██║   ██║███████╗█████╗   ╚████╔╝ ██████╔╝█████╗  ██████╔╝
# ██╔══██╗██║   ██║╚════██║██╔══╝    ╚██╔╝  ██╔═══╝ ██╔══╝  ██╔═══╝ 
# ██║  ██║╚██████╔╝███████║███████╗   ██║   ██║     ███████╗██║     
# ╚═╝  ╚═╝ ╚═════╝ ╚══════╝╚══════╝   ╚═╝   ╚═╝     ╚══════╝╚═╝    



TARGET = s21_containers.a
TARGET_PLUS = s21_containerplus.a

# ---------------------------------------------------------------------------------------
# --------- compliler variables

CC := g++
CFLAGS := -Wall -Werror -Wextra -std=c++17 -g -O0 --coverage
LIBS := 

SRC_EXT := cpp

# ---------------------------------------------------------------------------------------
# --------- code base

SRC_DIR := ./src
SRC := $(wildcard $(SRC_DIR)/*.$(SRC_EXT))
SRC := $(wildcard $(SRC_DIR)/*.$(SRC_EXT))
OBJ_DIR := ./obj
OBJ := $(patsubst $(SRC_DIR)/%.$(SRC_EXT), $(OBJ_DIR)/%.o, $(SRC))

# ---------------------------------------------------------------------------------------
# --------- tests


TEST_DIR := ./tests/
TEST_TARGET:= $(TEST_DIR)/test

TEST_SRC_DIR = $(TEST_DIR)
TEST_SRC := $(wildcard $(TEST_SRC_DIR)/*.$(SRC_EXT))

TEST_LIBS := -lgtest -lgtest_main -pthread


ALL_SRC_FILES :=  $(SRC_DIR)/*.h $(TEST_DIR)/*.h $(TEST_DIR)/*.cpp

# ---------------------------------------------------------------------------------------
# --------- MAIN TARGETS

all: $(TARGET) $(TARGET_PLUS)

build: $(TARGET)

rebuild: clean $(TARGET)

# ---------------------------------------------------------------------------------------
# --------- MAIN RULES

# Правило создания объектников
$(OBJ_DIR)/%.o : $(SRC_DIR)/%.$(SRC_EXT) | $(OBJ_DIR)
	$(CC) -c $(CFLAGS) $< -o $@

# Cоздание папки для объектных файлов
$(OBJ_DIR):
	mkdir -p $@

# ---------------------------------------------------------------------------------------
# --------- TARGETS

sandbox: $(TARGET) sandbox.cpp
	g++ -g -o sandbox_exe sandbox.cpp -L. -l:$(TARGET) -I./src
	./sandbox_exe

$(TARGET): $(OBJ)
	@ar rcs $@ $^

$(TARGET_PLUS): $(OBJ)
	@ar rcs $@ $^

$(TEST_TARGET): clean $(TARGET) $(TEST_SRC)
	@g++ $(CFLAGS) $(TEST_SRC) $(TEST_FLAGS) $(TEST_LIBS) $(TARGET) -o $(TEST_TARGET)

test_build: $(TEST_TARGET)

test: $(TEST_TARGET)
	@./$(TEST_TARGET)

style:
	@clang-format -style=Google -n ./src/*.h ./tests/*.cpp

format:
	@clang-format -style=Google -i ./src/*.h ./tests/*.cpp


leaks: $(TEST_TARGET)
	@leaks -atExit -- $(TEST_TARGET)

valgrind: $(TEST_TARGET)
	valgrind -s --tool=memcheck --leak-check=yes $(TEST_TARGET)

gcov_report: $(TEST_TARGET)
	./$(TEST_TARGET)
	lcov --capture --directory $(TEST_DIR) --output-file coverage.info  --ignore-errors mismatch  --ignore-errors unused
	lcov --remove coverage.info '/usr/*' '/path/to/gtest/*' --output-file coverage_filtered.info --ignore-errors mismatch  --ignore-errors unused
	genhtml coverage_filtered.info --output-directory coverage_report

clean:
	@find . -name "*.o" -type f -delete
	@find . -name "*.a" -type f -delete
	@rm -f $(TEST_TARGET) a.out
	@find . -name "*.info" -type f -delete
	@find . -name "*.gcda" -type f -delete
	@find . -name "*.gcno" -type f -delete
	@rm -rf coverage_report


.PHONY: all build rebuild test style_check format_style leaks valgrind clean

# /**
#  *                             _ooOoo_
#  *                            o8888888o
#  *                            88" . "88
#  *                            (| -_- |)
#  *                            O\  =  /O
#  *                         ____/`---'\____
#  *                       .'  \\|     |//  `.
#  *                      /  \\|||  :  |||//  \
#  *                     /  _||||| -:- |||||-  \
#  *                     |   | \\\  -  /// |   |
#  *                     | \_|  ''\---/''  |   |
#  *                     \  .-\__  `-`  ___/-. /
#  *                   ___`. .'  /--.--\  `. . __
#  *                ."" '<  `.___\_<|>_/___.'  >'"".
#  *               | | :  `- \`.;`\ _ /`;.`/ - ` : | |
#  *               \  \ `-.   \_ __\ /__ _/   .-` /  /
#  *          ======`-.____`-.___\_____/___.-`____.-'======
#  *                             `=---='
#  *          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
#  *                     佛祖保佑        永无BUG
#  *            佛曰:
#  *                   写字楼里写字间，写字间里程序员；
#  *                   程序人员写程序，又拿程序换酒钱。
#  *                   酒醒只在网上坐，酒醉还来网下眠；
#  *                   酒醉酒醒日复日，网上网下年复年。
#  *                   但愿老死电脑间，不愿鞠躬老板前；
#  *                   奔驰宝马贵者趣，公交自行程序员。
#  *                   别人笑我忒疯癫，我笑自己命太贱；
#  *                   不见满街漂亮妹，哪个归得程序员？
#  */
